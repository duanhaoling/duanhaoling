---
layout: post
title: "Android原生WebView定位权限填坑"
category: other
---
### 结论

首先是结论

[android webview定位权限请求](https://blog.csdn.net/qugengting/article/details/85256606)，按这篇文章走下来，可以解决部分手机部分场景的问题。

然而新安装的APP，必须去设置中手动允许一次APP定位权限才行，否则原生webView就获取不到这个权限，导致定位失败。

一开始申请权限点拒绝不行，同意也不行，都需要去系统设置中打开或者关闭再打开。。。

这是安卓的bug吧？？？

### 解决方案
有如下三个
1. 替换腾讯webview
2. 提示用户去手动重新打开一下定位权限
3. 提供一个java的native方法供h5端调用，获取我们原生sdk的定位坐标展示到h5页面里。

### 关于焦虑

如果没有充足的时间，排期开发新需求的同时遇到难改的bug，是最容易焦虑的。

最近身体各种不适，而焦虑直接导致头痛以及睡不好。还好这个版本没有之前那么忙。

因为这个问题加了两天班，一步步缩小范围，所以记个流水账。希望以后遇到这种bug，可以不要焦虑了。

### 背景与过程

这一天改完上个需求的测试bug，伸个懒腰，收拾好东西准备打卡下班了，迎面来了两个H5的同学要问一个安卓手机打开h5页面定位不准的问题。。。

打开我们APP的H5页面，打开地图，点击当前位置，嗯？定位到上海天潼路了，看了一下定位权限是一打开APP就申请过的

顺带研究了一下浏览器中h5的定位以及公司其他APP的定位，没问题。

看来的确是我们APP的问题了，那会是什么原因呢？初步怀疑webView有一套单独的权限系统，独立于应用之外。

去网上搜了一下“webView获取不到位置信息”，[android webview定位权限请求](https://blog.csdn.net/qugengting/article/details/85256606)，看起来是个小问题。里面提到在AndroidSDK23以上只支持https，我们的网站是https的，没这个问题。

第二天上午，改过试了一下，好了，美滋滋，于是交给h5同学了。

然而事情并没有这么简单，第二天晚上要发布小版本了，h5同学突然反馈他的小米手机还是定位不行，我自己的测试机卸载重装那个版本，居然也不行。。

一路试错下来，发现覆盖安装就可以，卸载重装就不行。。而我的华为nova2s，覆盖安装也不行。。又一天在加班中过去了。。兼容性问题的坑。。



于是第三天，这一天不想加班了，bug容易让人焦虑。。打开公司另外一款app的代码，看下来配置也是这么多，不同的是他们用的是腾讯的x5webview，并没有什么参考性，这时候紧急替换WebView不太现实。网上没有相关的文章，只能自己硬磕了。

观察日志，有一个系统报错信息

```
E/FastNetworkLocation: location time is older!!
```

换google搜索下来并没有什么用，都还是那篇文章里的东西，加上申请权限。我这边是明明有权限的，而且oppo以及小米手机卸载重装就不行，覆盖安装就可以。

或者说

>  修改 自己app的build.gradle 里面一个targetSdkVersion 23 (为什么写23 高德地图告诉我的) （这里是关键）

我们的项目已经适配到28了，降到23，即不现实，也很无厘头。

于是继续用我的华为nova2s尝试卸载重装场景，把一开始申请多个权限改为在一开始点拒绝定位，然后onGeolocationPermissionsShowPrompt()中单独申请定位权限，去配置中打开定位权限，然后杀进程，可以定位了。。

就是说新安装的app，权限必须重新打开一下才行吗？

继续尝试，一开始不批量申请定位权限，到定位的地方onGeolocationPermissionsShowPrompt方法中首次申请权限并同意，杀进程重启，依然不行。。

第一次申请权限是可以在app中同意的，拒绝再次申请的话只能自己去设置中打开应用的权限开关。

看来最准确的描述是必须去设置中手动允许一次定位才行，否则webView就获取不到这个权限。而腾讯的webView，应该规避了这个权限不同步的问题。





